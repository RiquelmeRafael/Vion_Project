@model Vion.Domain.Entities.Produto

@{
    ViewData["Title"] = "Editar Produto";
}

<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-title">Editar Produto</h1>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="admin-card">
                <div class="card-header">
                    <h4 class="mb-0 text-dark">Informações do Produto</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="CreatedAt" />

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Nome" class="admin-form-label">Nome</label>
                                <input asp-for="Nome" class="admin-form-control w-100" />
                                <span asp-validation-for="Nome" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Preco" class="admin-form-label">Preço</label>
                                <input asp-for="Preco" class="admin-form-control w-100" type="number" step="0.01" />
                                <span asp-validation-for="Preco" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="ValorFreteFixo" class="admin-form-label">Frete Fixo (Opcional)</label>
                                <input asp-for="ValorFreteFixo" class="admin-form-control w-100" type="number" step="0.01" />
                                <span asp-validation-for="ValorFreteFixo" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Descricao" class="admin-form-label">Descrição</label>
                            <textarea asp-for="Descricao" class="admin-form-control w-100" rows="3"></textarea>
                            <span asp-validation-for="Descricao" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoriaId" class="admin-form-label">Categoria</label>
                                <select asp-for="CategoriaId" class="admin-form-control w-100" asp-items="ViewBag.CategoriaId"></select>
                                <span asp-validation-for="CategoriaId" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Seleção de Tamanhos e Estoque (Múltiplo) -->
                        <div class="card mb-3 border-light shadow-sm">
                            <div class="card-header bg-white border-bottom">
                                <h6 class="mb-0 text-dark fw-bold">Tamanhos e Estoque (Gerenciar Variantes)</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="sticky-top bg-light">
                                            <tr>
                                                <th class="text-center" width="50"><i class="fas fa-check text-muted"></i></th>
                                                <th class="text-dark">Tamanho</th>
                                                <th width="150" class="text-dark">Estoque</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                var existingVariants = ViewData["ExistingVariants"] as Dictionary<int, int>;
                                            }
                                            @foreach (var item in (SelectList)ViewBag.TamanhoId)
                                            {
                                                var tamId = int.Parse(item.Value);
                                                var isSelected = existingVariants != null && existingVariants.ContainsKey(tamId);
                                                var stockValue = isSelected ? existingVariants![tamId] : 0;
                                                
                                                <tr>
                                                    <td class="text-center align-middle">
                                                        <div class="form-check d-flex justify-content-center">
                                                            <input type="checkbox" name="TamanhosSelecionados" value="@item.Value" 
                                                                   class="form-check-input size-check" id="check_@item.Value"
                                                                   @(isSelected ? "checked" : "") />
                                                        </div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <label class="form-check-label w-100 cursor-pointer text-dark" for="check_@item.Value">
                                                            @item.Text
                                                        </label>
                                                    </td>
                                                    <td>
                                                        <input type="number" name="EstoquePorTamanho[@item.Value]" 
                                                               class="admin-form-control stock-input form-control-sm" 
                                                               value="@stockValue" min="0" 
                                                               @(isSelected ? "" : "disabled") />
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer text-muted small bg-white border-top">
                                Marque os tamanhos disponíveis para este produto e defina o estoque de cada um.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="CupomId" class="admin-form-label">Cupom de Desconto (Opcional)</label>
                            <select asp-for="CupomId" class="admin-form-control w-100" asp-items="ViewBag.CupomId">
                                <option value="">Selecione um cupom (Opcional)</option>
                            </select>
                            <small class="text-muted">Selecione um cupom para exibir o aviso "Produto com desconto" no site.</small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Cor" class="admin-form-label">Cor</label>
                            <input asp-for="Cor" class="admin-form-control w-100" />
                            <span asp-validation-for="Cor" class="text-danger"></span>
                        </div>

                        <h5 class="mt-4 mb-3 text-dark border-bottom pb-2">Imagens do Produto</h5>
                        <div class="row g-3 mb-4">
                            <!-- Imagem 1 (Principal) -->
                            <div class="col-6 col-md-3">
                                <div class="card h-100 bg-white border shadow-sm">
                                    <div class="card-header text-center small fw-bold bg-light text-dark border-bottom">Principal</div>
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 180px;">
                                        <img id="preview1" src="@Model.ImagemUrl" class="img-fluid @(string.IsNullOrEmpty(Model.ImagemUrl) ? "d-none" : "")" style="max-height: 100%; max-width: 100%; object-fit: contain;" />
                                        <div id="placeholder1" class="text-center text-muted small @(!string.IsNullOrEmpty(Model.ImagemUrl) ? "d-none" : "")">
                                            <i class="fas fa-image fa-2x mb-1"></i><br>Sem imagem
                                        </div>
                                    </div>
                                    <div class="card-footer p-2 bg-white border-top">
                                        <div class="mb-1">
                                            <input type="file" name="img1" id="file1" class="form-control form-control-sm" accept="image/*" onchange="updatePreview('file1', 'url1', 'preview1', 'placeholder1')" />
                                        </div>
                                        <div>
                                            <input asp-for="ImagemUrl" id="url1" class="form-control form-control-sm" placeholder="Ou cole a URL..." oninput="updatePreview('file1', 'url1', 'preview1', 'placeholder1')" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Imagem 2 -->
                            <div class="col-6 col-md-3">
                                <div class="card h-100 bg-white border shadow-sm">
                                    <div class="card-header text-center small fw-bold bg-light text-dark border-bottom">Imagem 2</div>
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 180px;">
                                        <img id="preview2" src="@Model.ImagemUrl2" class="img-fluid @(string.IsNullOrEmpty(Model.ImagemUrl2) ? "d-none" : "")" style="max-height: 100%; max-width: 100%; object-fit: contain;" />
                                        <div id="placeholder2" class="text-center text-muted small @(!string.IsNullOrEmpty(Model.ImagemUrl2) ? "d-none" : "")">
                                            <i class="fas fa-image fa-2x mb-1"></i><br>Sem imagem
                                        </div>
                                    </div>
                                    <div class="card-footer p-2 bg-white border-top">
                                        <div class="mb-1">
                                            <input type="file" name="img2" id="file2" class="form-control form-control-sm" accept="image/*" onchange="updatePreview('file2', 'url2', 'preview2', 'placeholder2')" />
                                        </div>
                                        <div>
                                            <input asp-for="ImagemUrl2" id="url2" class="form-control form-control-sm" placeholder="Ou cole a URL..." oninput="updatePreview('file2', 'url2', 'preview2', 'placeholder2')" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Imagem 3 -->
                            <div class="col-6 col-md-3">
                                <div class="card h-100 bg-white border shadow-sm">
                                    <div class="card-header text-center small fw-bold bg-light text-dark border-bottom">Imagem 3</div>
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 180px;">
                                        <img id="preview3" src="@Model.ImagemUrl3" class="img-fluid @(string.IsNullOrEmpty(Model.ImagemUrl3) ? "d-none" : "")" style="max-height: 100%; max-width: 100%; object-fit: contain;" />
                                        <div id="placeholder3" class="text-center text-muted small @(!string.IsNullOrEmpty(Model.ImagemUrl3) ? "d-none" : "")">
                                            <i class="fas fa-image fa-2x mb-1"></i><br>Sem imagem
                                        </div>
                                    </div>
                                    <div class="card-footer p-2 bg-white border-top">
                                        <div class="mb-1">
                                            <input type="file" name="img3" id="file3" class="form-control form-control-sm" accept="image/*" onchange="updatePreview('file3', 'url3', 'preview3', 'placeholder3')" />
                                        </div>
                                        <div>
                                            <input asp-for="ImagemUrl3" id="url3" class="form-control form-control-sm" placeholder="Ou cole a URL..." oninput="updatePreview('file3', 'url3', 'preview3', 'placeholder3')" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Imagem 4 -->
                            <div class="col-6 col-md-3">
                                <div class="card h-100 bg-white border shadow-sm">
                                    <div class="card-header text-center small fw-bold bg-light text-dark border-bottom">Imagem 4</div>
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 180px;">
                                        <img id="preview4" src="@Model.ImagemUrl4" class="img-fluid @(string.IsNullOrEmpty(Model.ImagemUrl4) ? "d-none" : "")" style="max-height: 100%; max-width: 100%; object-fit: contain;" />
                                        <div id="placeholder4" class="text-center text-muted small @(!string.IsNullOrEmpty(Model.ImagemUrl4) ? "d-none" : "")">
                                            <i class="fas fa-image fa-2x mb-1"></i><br>Sem imagem
                                        </div>
                                    </div>
                                    <div class="card-footer p-2 bg-white border-top">
                                        <div class="mb-1">
                                            <input type="file" name="img4" id="file4" class="form-control form-control-sm" accept="image/*" onchange="updatePreview('file4', 'url4', 'preview4', 'placeholder4')" />
                                        </div>
                                        <div>
                                            <input asp-for="ImagemUrl4" id="url4" class="form-control form-control-sm" placeholder="Ou cole a URL..." oninput="updatePreview('file4', 'url4', 'preview4', 'placeholder4')" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-action="Index" class="btn-admin-cancel me-md-2">Cancelar</a>
                            <button type="submit" class="btn-admin-save">
                                <i class="fa-solid fa-save"></i> Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        function updatePreview(fileInputId, urlInputId, imgId, placeholderId) {
            const fileInput = document.getElementById(fileInputId);
            const urlInput = document.getElementById(urlInputId);
            const preview = document.getElementById(imgId);
            const placeholder = document.getElementById(placeholderId);
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                    placeholder.classList.add('d-none');
                }
                reader.readAsDataURL(fileInput.files[0]);
            } else if (urlInput.value && urlInput.value.trim() !== '') {
                preview.src = urlInput.value;
                preview.classList.remove('d-none');
                placeholder.classList.add('d-none');
                
                preview.onerror = function() {
                    preview.classList.add('d-none');
                    placeholder.classList.remove('d-none');
                };
            } else {
                preview.src = '#';
                preview.classList.add('d-none');
                placeholder.classList.remove('d-none');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.size-check');
            checkboxes.forEach(chk => {
                chk.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const input = row.querySelector('.stock-input');
                    if (this.checked) {
                        input.disabled = false;
                        if (input.value === "0") input.value = "0"; 
                        input.focus();
                    } else {
                        input.disabled = true;
                    }
                });
            });
        });
    </script>
}
