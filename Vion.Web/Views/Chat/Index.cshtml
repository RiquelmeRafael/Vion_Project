@model Vion.Domain.Entities.ChatConversation

@{
    ViewData["Title"] = "Suporte";
}

<style>
    .chat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        background: #fff;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .chat-messages {
        height: 500px;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message-bubble {
        max-width: 75%;
        padding: 12px 16px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.5;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .message-mine {
        align-self: flex-end;
        background-color: #2563eb;
        color: white;
        border-radius: 18px 18px 2px 18px;
    }

    .message-other {
        align-self: flex-start;
        background-color: white;
        color: #1e293b;
        border: 1px solid #e2e8f0;
        border-radius: 18px 18px 18px 2px;
    }

    .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.8;
        text-align: right;
        display: block;
    }

    .chat-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid #e2e8f0;
    }

    .btn-send {
        background-color: #2563eb;
        color: white;
        border-radius: 50%;
        width: 46px;
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        border: none;
    }
    
    .btn-send:hover {
        background-color: #1d4ed8;
        transform: scale(1.05);
    }
    
    /* Scrollbar estilizada */
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    .chat-messages::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
                <div class="chat-card">
                    <!-- Header -->
                    <div class="chat-header d-flex align-items-center gap-3">
                        <div class="rounded-circle overflow-hidden d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background-color: rgba(15,23,42,0.4);">
                            <img src="~/images/Atendimento.png" alt="Atendimento Vion" class="img-fluid">
                        </div>
                    <div>
                        <h5 class="mb-0 fw-bold">Suporte Vion</h5>
                        <small class="text-white-50">Estamos online para ajudar</small>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="chat-messages" id="messagesArea">
                    <div class="message-bubble message-other">
                        O que podemos te ajudar hoje?
                    </div>

                    @if (Model != null && Model.Mensagens != null && Model.Mensagens.Any())
                    {
                        foreach (var msg in Model.Mensagens.OrderBy(m => m.EnviadoEm))
                        {
                            var isMine = !msg.RemetenteEhStaff;
                            <div class="message-bubble @(isMine ? "message-mine" : "message-other")" data-message-id="@msg.Id">
                                @msg.Conteudo
                                <span class="message-time">@msg.EnviadoEm.ToString("HH:mm")</span>
                            </div>
                        }
                    }
                </div>

                <!-- Input Area -->
                <div class="chat-input-area">
                    <form asp-action="EnviarMensagem" method="post" class="d-flex align-items-center gap-2" data-chat-cliente="true">
                        <div class="flex-grow-1">
                            <input type="text" name="conteudo" class="form-control form-control-lg border-0 bg-light" 
                                   placeholder="Digite sua mensagem..." required autocomplete="off" style="border-radius: 24px; padding-left: 20px;">
                        </div>
                        <button type="submit" class="btn-send shadow-sm">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            var messagesArea = $('#messagesArea');
            var conversationId = @(Model?.Id ?? 0);
            var lastMessageId = parseInt(messagesArea.find('.message-bubble').last().data('message-id')) || 0;

            function scrollToBottom() {
                var el = messagesArea[0];
                if (el) {
                    el.scrollTop = el.scrollHeight;
                }
            }

            function appendMessage(m, isMine) {
                var bubble = $('<div>')
                    .addClass('message-bubble')
                    .addClass(isMine ? 'message-mine' : 'message-other')
                    .attr('data-message-id', m.id);
                bubble.append(document.createTextNode(m.conteudo));
                var timeSpan = $('<span>')
                    .addClass('message-time')
                    .text(m.hora);
                bubble.append(timeSpan);
                messagesArea.append(bubble);
                lastMessageId = m.id;
                scrollToBottom();
            }

            function carregarNovasMensagens() {
                $.getJSON('@Url.Action("ObterMensagens")', { conversationId: conversationId, lastMessageId: lastMessageId })
                    .done(function (resp) {
                        if (!resp || !resp.mensagens) return;
                        for (var i = 0; i < resp.mensagens.length; i++) {
                            var m = resp.mensagens[i];
                            appendMessage(m, !m.remetenteEhStaff);
                        }
                    });
            }

            setInterval(carregarNovasMensagens, 3000);

            var form = $('form[data-chat-cliente="true"]');
            form.on('submit', function (e) {
                e.preventDefault();
                var input = form.find('input[name="conteudo"]');
                var texto = input.val();
                if (!texto || !texto.trim()) return;
                $.post('@Url.Action("EnviarMensagemAjax")', { conversationId: conversationId, conteudo: texto })
                    .done(function (m) {
                        appendMessage(m, true);
                        input.val('');
                    });
            });

            scrollToBottom();
        });
    </script>
}
